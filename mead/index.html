<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<title>Mead Numbers</title>
</head>
<body>
    <div class="form-box">
        <h1>ABV / Delle Calculator</h1>
        <form name="calc">
            <div class="form-group mb-2">
                <label for="og">OG</label>
                <div class="input-group">
                    <input class="form-control" id="og" name="OG"
                        type="number" step="0.001" value="1.140"
                        oninput="updateCalculations(this)" >
                    <div class="input-group-text"><input class="form-check-input mt-0" type="radio" name="target" value="og" onchange="targetChanged(this);"></div>
                </div>
            </div>
            <div class="form-group mb-2">
                <label for="fg">FG</label>
                <div class="input-group">
                    <input class="form-control" id="fg" name="FG"
                        type="number" step="0.001" value="1.040"
                        oninput="updateCalculations(this);" >
                    <div class="input-group-text"><input class="form-check-input mt-0" type="radio" name="target" value="fg" onchange="targetChanged(this);"></div>
                </div>
            </div>
            <div class="form-group mb-2">
                <label for="abv">ABV (%)</label>
                <div class="input-group">
                    <input class="form-control" id="abv" name="ABV" 
                        type="number" step="0.1" value="0.0" disabled="true"
                        oninput="updateCalculations(this);" >
                    <div class="input-group-text"><input class="form-check-input mt-0" type="radio" name="target" value="abv" checked  onchange="targetChanged(this);"></div>
                </div>
            </div>
            <div class="form-group mb-2">
                <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                title="ABV calculation method"
                data-bs-container="body"
                viewport="container"
                data-bs-content='There are various ways to approximate ABV from a given OG and FG.
                <br><br>
                Baume <code>145-145/(1+og-fg)</code> is used by <a href="http://meadcalc.freevar.com/">MeadCalc</a> and <a href="https://gotmead.com/blog/the-mead-calculator/">GotMead</a>.
                <br><br>
                Linear <code>(og-fg)*131.25</code> is used by <a href="https://www.brewersfriend.com/abv-calculator/">Brewers Friend</a> "standard". Interestingly, this formula is derived directly from the molecular weights of CO2 and Ethanol.
                <br><br>
                Duncan & Acton <code>(1000 * (og - fg)) / (7.75 - (3.75 * (og - k - 1)))</code> is used by <a href="https://fermcalc.com/">FermCalc</a>.
                '></a>
                <label for="abvmethod">ABV Calculation Method</label>
                <select id="abvmethod" class="form-select"
                    onchange="updateCalculations(this);">
                    <option value="BAUME" selected>Baume</option>
                    <option value="LINEAR">Linear</option>
                    <option value="DUNCANACTON">Duncan & Acton</option>
                </select>
            </div>
            <!-- ^^^ inputs ^^^                   vvv outputs vvv -->
            <hr class="hr hr-blurry" />
            <div class="form-group mb-2">
                <label for="nafg">
                    <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                       title="Non-alcohol final gravity"
                       data-bs-content="Alcohol has a density less than water, so its presence reduces the specific gravity
                       of your must. We can reliably calculate the specific gravity of the must minus the influence of alcohol's low
                       density, given the ABV. We are actually calculating what the SG would be if we replaced the pure alcohol with pure water."></a>
                    Non-alcohol FG
                </label>
                <input class="form-control" id="nafg" type="number" name="NAFG" value="0" disabled="true">
            </div>
            <div class="form-group mb-2">
                <label for="rs">
                    <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                       title="Approximate Residual sugars"
                       data-bs-content="We calculate the residual sugars by converting the ABV-adjusted final gravity
                       into Brix. We use a standard SG to Brix conversion, and then multiply again by the non-alcohol FG, as
                       described at <a href='https://www.vinolab.hr/calculator/gravity-density-sugar-conversions-en19'>Vinolab</a>."></a>
                       Approx. residual sugars
                    </label>
                <input class="form-control" id="rs" type="number" name="RS" value="0" disabled="true">
            </div>
            <div class="form-group mb-2">
                <label for="delle">
                    <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                       title="Approximate Delle units"
                       data-bs-content="We calculate the Delle units from the ABV and the residual sugars."></a>
                       Approx. Delle units
                    </label>
                <input class="form-control" id="delle" type="number" name="Delle" value="0" disabled="true">
            </div>
            
        </form>
      </div>
      <script>
        // INTERFACE

        // helpers / abbrevs
        const getid = (id => document.getElementById(id));
        const getval = (id => document.getElementById(id).value);
        const getnum = (id => Number(document.getElementById(id).value));

        // this rounds values in an output field to 3dp. not currently used.
        const limit_to_3dp = false;
        function setSGDisplay(el) {
            if (limit_to_3dp)
                el.value = parseFloat(el.value).toFixed(3);
        };

        // disables the target element (of the main three), and enables the other two.
        function setTargetElement(target) {
            ["og", "fg", "abv"].forEach(id => {
                getid(id).disabled = (id === target);
            });
        }

        // get the id of the currently disabled element (this is the target element)
        function getTargetElement() {
            return ["og", "fg", "abv"].find(id => getid(id).disabled);
        }

        // when the "target" (solve for) radio selection is changed.
        function targetChanged(el) {
            const newTarget = document.forms.calc.elements.target.value;
            setTargetElement(newTarget);
        }

        // update calculations when some input has changed.
        function updateCalculations(el) {
            if (el && el.disabled) return;
            var target = getTargetElement();
            switch (target) {
                case "abv": updateABV(); break;
                case "og": updateOG(); break;
                case "fg": updateFG(); break;
            }
            // always update the secondary fields
            updateSecondary();
        }

        function updateSecondary() {
            const fg = getnum("fg");
            const abv = getnum("abv");
            const nafg = updateNAFG(abv, fg);
            updateRS(nafg);
            updateDelle(abv);
        }

        function updateOG(fg, abv) {
            if (fg===undefined) fg = getnum("fg");
            if (abv===undefined) abv = getnum("abv");
            const og = OGFromFGABV(fg, abv);
            getid("og").value = smartRound(og);
            return og;
        }

        function updateFG(og, abv) {
            if (og===undefined) og = getnum("og");
            if (abv===undefined) abv = getnum("abv");
            const fg = FGFromOGABV(og, abv);
            getid("fg").value = smartRound(fg);
            return fg;
        }

        function updateABV(og, fg) {
            if (og===undefined) og = getnum("og");
            if (fg===undefined) fg = getnum("fg");
            const abv = ABVFromSGs(og, fg);
            getid("abv").value = smartRound(abv);
            return abv;
        }

        function updateNAFG(abv, fg) {
            if (abv === undefined) abv = getnum("abv");
            if (fg === undefined)  fg = getnum("fg");
            const nafg = adjustForAlcohol(fg, abv);
            getid("nafg").value = smartRound(nafg);
            return nafg;
        }

        function updateRS(nafg) {
            if (nafg === undefined) nafg = getnum("nafg");
            const rs = BrixFromSG(nafg) * nafg;
            getid("rs").value = smartRound(rs);
            return rs;
        }

        function updateDelle(abv, rs) {
            if (abv === undefined) abv = getnum("abv");
            if (rs === undefined) rs = getnum("rs");
            const delle = DelleFromRSABV(rs, abv);
            getid("delle").value = smartRound(delle);
            return delle;
        }


        // conversions
        function getABVMethod() {
            return (getid("abvmethod").value);
        }

        function ABVFromSGs(og, fg) {
            switch (getABVMethod()) {
                case "BAUME":
                    return BaumeABV(og, fg);
                case "LINEAR":
                    return LinearABV(og, fg);
                case "DUNCANACTON":
                    return DuncanActonABV(og, fg);
                default:
                    alert("something went wrong. I guess we haven't finished developing this ABV calculation method yet."); return;
            }
        }

        function OGFromFGABV(fg, abv) {
            switch (getABVMethod()) {
                case "BAUME":
                    return BaumeOG(fg, abv);
                case "LINEAR":
                    return LinearOG(fg, abv);
                case "DUNCANACTON":
                    return DuncanActonOG(fg, abv);
                default:
                    alert("something went wrong. I guess we haven't finished developing this ABV calculation method yet."); return;
            }
        }

        function FGFromOGABV(og, abv) {
            switch (getABVMethod()) {
                case "BAUME":
                    return BaumeFG(og, abv);
                case "LINEAR":
                    return LinearFG(og, abv);
                case "DUNCANACTON":
                    return DuncanActonFG(og, abv);
                default:
                    alert("something went wrong. I guess we haven't finished developing this ABV calculation method yet."); return;
            }
        }

        // the Baume method
        function BaumeABV(og, fg) {
            return 145-145/(1+og-fg);
        }

        function BaumeFG(og, abv) {
            return (1+og) - 145/(145-abv);
        }

        function BaumeOG(fg, abv) {
            return 145/(145-abv) - (1-fg);
        }

        // the linear method
        function LinearABV(og, fg) {
            return (og-fg)*131.25;
        }

        function LinearFG(og, abv) {
            return og - (abv/131.25);
        }

        function LinearOG(fg, abv) {
            return (abv/131.25) + fg;
        }

        // the Duncan Acton method
        function DuncanActonABV(og, fg, k) {
            if (k === undefined) k = 0.007;
            const abv = (1000 * (og - fg)) / (7.75 - (3.75 * (og - k - 1)));
            return abv;
        }

        function DuncanActonFG(og, abv, k) {
            if (k === undefined) k = 0.007;
            const fg = og + (abv*3.75*og - abv*(3.75*k + 11.5))/1000;
            return fg;
        }

        function DuncanActonOG(fg, abv, k) {
            if (k === undefined) k = 0.007;
            const og = (1000*fg + abv*(3.75*k + 11.5))/(1000 + abv*3.75);
            return og;
        }

        // "Smart" rounding. Do a small round if you ever find '000' or '999'
        // in the decimal places. This is a weird round with a base 10 bias, but
        // it makes numbers that look nice, and it often corrects for rounding
        // errors created by recalculating using complex calculated numbers, as
        // often happens when you change target.
        function smartRound(n) {
            // ignore if already simple under 4dp
            if (n == Number(n.toFixed(4))) return n;

            const decimals = n.toString().substring(n.toString().indexOf('.')+1);
            const zeroes = decimals.indexOf('000');
            const nines  = decimals.indexOf('999');

            var cutoff;
            if (zeroes === -1 && nines === -1) return n;
            if (zeroes > -1 && nines > -1) cutoff = Math.min(zeroes, nines);
            else cutoff = Math.max(zeroes, nines);

            const simpleN = Number(n.toFixed(cutoff));
            console.log("simplified", n, "to", simpleN);
            return simpleN;
        }

        function adjustForAlcohol(sg, abv) {
            /* const removeEthanol = (sg*100 - 0.789*abv) / (100-abv);
            const diluteBackToVolume = (removeEthanol*(100-abv) + abv) / 100;
            return diluteBackToVolume;
            this simplifies to the following */
            return sg + 0.00211 * abv;
        }


        function BrixFromSG(sg) {
            const brix = 182.4601 * Math.pow(sg, 3)
                       - 775.6821 * Math.pow(sg, 2)
                       + 1262.7794 * sg
                       - 669.5622;
            return brix;
        }

        function DelleFromRSABV(rs, abv) {
            if (rs === undefined) rs = getnum("rs");
            if (abv === undefined) abv = getnum("abv");
            return 4.5 * abv + rs;
        }

        updateCalculations();

        // interface stuff
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, {html:true, container: 'body'});
        });
      </script>
</body>
</html>