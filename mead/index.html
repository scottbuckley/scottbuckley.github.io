<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<style>
    .form-group :has(~ .d-none):not(:has(~ :not(.d-none))) {
        border-top-right-radius: 0.25rem !important;
        border-bottom-right-radius: 0.25rem !important;
    }
</style>
<title>Mead Numbers</title>
</head>
<body>
    <div class="form-box">
        <h1>Mead Numbers</h1>
        <form name="calc">
            <div class="form-group mb-2">
                <label for="og">OG</label>
                <div class="input-group">
                    <label class="input-group-text" for="targetog"><input class="form-check-input mt-0" type="radio" name="target" id="targetog" value="og" onchange="targetChanged(this);"></label>
                    <input class="form-control w-25" id="og" name="OG"
                        type="number" step="0.001" value="1.140"
                        oninput="updateCalculations(this)" >
                    <span class="input-group-text tempcorrectionon">@</span>
                    <input class="form-control tempcorrectionon" id="ogtemp" name="OGTemp"
                        type="number" step="0.1" placeholder="Temp" value="20"
                        oninput="updateCalculations(this)" >
                    <span class="input-group-text tempcorrectionon show-temp-unit">&#8451</span>
                </div>
                <div class="tempcorrectionon">
                    <span>=</span>&nbsp;<span id="ogtempcorrected">temp</span>&nbsp;<span>@</span>&nbsp;<span class="show-basis-temp">12345</span>&nbsp;<span class="show-temp-unit">&#8451</span>
                </div>
            </div>
            <div class="form-group mb-2">
                <label for="fg">FG</label>
                <div class="input-group">
                    <label class="input-group-text" for="targetfg"><input class="form-check-input mt-0" type="radio" name="target" id="targetfg" value="fg" onchange="targetChanged(this);"></label>
                    <input class="form-control w-25" id="fg" name="FG"
                        type="number" step="0.001" value="1.040"
                        oninput="updateCalculations(this);" >
                    <span class="input-group-text tempcorrectionon">@</span>
                    <input class="form-control tempcorrectionon" id="fgtemp" name="FGTemp"
                        type="number" step="0.1" placeholder="Temp" value="20"
                        oninput="updateCalculations(this)" >
                    <span class="input-group-text tempcorrectionon show-temp-unit">&#8451</span>
                </div>
                <div class="tempcorrectionon">
                    <span>=</span>&nbsp;<span id="fgtempcorrected">temp</span>&nbsp;<span>@</span>&nbsp;<span class="show-basis-temp">12345</span>&nbsp;<span class="show-temp-unit">&#8451</span>
                </div>
            </div>
            <div class="form-group mb-2">
                <label for="abv">ABV</label>
                <div class="input-group">
                    <label class="input-group-text" for="targetabv"><input class="form-check-input mt-0" type="radio" name="target" id="targetabv" value="abv" checked  onchange="targetChanged(this);"></label>
                    <input class="form-control" id="abv" name="ABV" 
                        type="number" step="0.1" value="0.0" disabled="true"
                        oninput="updateCalculations(this);" >
                    <label class="input-group-text" for="abv">%</label>
                </div>
            </div>
            <div class="form-group mb-2">
                <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                title="ABV calculation method"
                data-bs-container="body"
                viewport="container"
                data-bs-content='There are various ways to approximate ABV from a given OG and FG.
                <br><br>
                Baume <code>145-145/(1+og-fg)</code> is used by <a href="http://meadcalc.freevar.com/">MeadCalc</a> and <a href="https://gotmead.com/blog/the-mead-calculator/">GotMead</a>.
                <br><br>
                Linear <code>(og-fg)*131.25</code> is used by <a href="https://www.brewersfriend.com/abv-calculator/">Brewers Friend</a> "standard".
                Interestingly, this formula is derived directly from the molecular weights of CO2 and Ethanol.
                They use 0.8 as the density of gravity, which is only accurate at about 7C.
                This implies that the true temperature basis would be 7C, but I assume it here to be 15.56C (60F), as there is no way that homebrewers everywhere have been using 7C (45F) with this method for years.
                Ethanols density is 0.792 at 15.56C and 0.789 at 20C.
                <br><br>
                Duncan & Acton <code>(1000 * (og - fg)) / (7.75 - (3.75 * (og - k - 1)))</code> is used by <a href="https://fermcalc.com/">FermCalc</a>.
                '></a>
                <label for="abvmethod">ABV Calculation Method</label>
                <select id="abvmethod" class="form-select"
                    onchange="updateCalculations(this);">
                    <option value="BAUME" selected>Baume</option>
                    <option value="LINEAR">Linear</option>
                    <option value="DUNCANACTON">Duncan & Acton</option>
                </select>
            </div>
            <!-- ^^^ inputs ^^^                   vvv outputs vvv -->
            <hr class="hr hr-blurry" />
            <div class="form-group mb-2">
                <label for="nafg">
                    <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                       title="Non-alcohol final gravity"
                       data-bs-content="Alcohol has a density less than water, so its presence reduces the specific gravity
                       of your must. We can reliably calculate the specific gravity of the must minus the influence of alcohol's low
                       density, given the ABV. We are actually calculating what the SG would be if we replaced the pure alcohol with pure water."></a>
                    Non-alcohol FG
                </label>
                <input class="form-control" id="nafg" type="number" name="NAFG" value="0" disabled="true">
            </div>
            <div class="form-group mb-2">
                <label for="rs">
                    <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                       title="Approximate Residual sugars"
                       data-bs-content="We calculate the residual sugars by converting the ABV-adjusted final gravity
                       into Brix. We use a standard SG to Brix conversion, and then multiply again by the non-alcohol FG, as
                       described at <a href='https://www.vinolab.hr/calculator/gravity-density-sugar-conversions-en19'>Vinolab</a>."></a>
                       Approx. residual sugars
                    </label>
                <input class="form-control" id="rs" type="number" name="RS" value="0" disabled="true">
            </div>
            <div class="form-group mb-2">
                <label for="delle">
                    <a tabindex="0" class="bi bi-info-circle" role="button" data-bs-toggle="popover" data-bs-trigger="focus"
                       title="Approximate Delle units"
                       data-bs-content="We calculate the Delle units from the ABV and the residual sugars."></a>
                       Approx. Delle units
                    </label>
                <input class="form-control" id="delle" type="number" name="Delle" value="0" disabled="true">
            </div>
            <hr class="hr hr-blurry" />
            <div class="form-group mb-2">
                <label for="delle">Gravity temperature correction</label>
                <div class="input-group">
                    <label class="input-group-text" for="tempcorrection"><input id="tempcorrection" class="form-check-input mt-0" type="checkbox" oninput="tempCorrectionToggle(this)"></label>
                    <!-- Temp Correction Off -->
                    <span class="input-group-text tempcorrectionoff">Off</span>
                    
                    <!-- Temp Correction On -->
                    <!-- <span class="input-group-text tempcorrectionon d-none">On</span> -->
                    <label class="input-group-text tempcorrectionon" for="tempC">Celcius</label>
                    <label class="input-group-text tempcorrectionon" for="tempC"><input checked class="form-check-input mt-0" type="radio" name="tempunit" id="tempC" value="C" onchange="updateCalculations();"></label>
                    <label class="input-group-text tempcorrectionon" for="tempF">Farenheit</label>
                    <label class="input-group-text tempcorrectionon" for="tempF"><input class="form-check-input mt-0" type="radio" name="tempunit" id="tempF" value="F" onchange="updateCalculations();"></label>
                </div>
            </div>
        </form>
      </div>
      <script>
        // INTERFACE

        // helpers / abbrevs
        const getid = (id => document.getElementById(id));

        // set the value of a number input, saving the precise value in the DOM
        // tree, but displaying a simplified number.
        const showRoundedValue = true;
        function setnum(id, val, dp=4) {
            const el = getid(id);
            el.preciseValue = val;
            el.preciseValueRounding = dp;
            if (showRoundedValue)
                el.value = val.toFixed(dp);
                // el.value = val;
            else
                el.value = val;
        }

        // get the value of a number input/output, using the precise value if it is
        // available (checking that is is close to the)
        function getnum(id) {
            const el = getid(id);
            if (el.preciseValue === undefined || el.preciseValueRounding === undefined)
                return Number(el.value);
            if (Number(el.preciseValue.toFixed(el.preciseValueRounding)) === Number(el.value)) {
                return el.preciseValue;
            } else {
                console.log("no match from preciseValue", id, ". Defaulting to displayed value.");
                // console.log(el.value);
                // console.log(el.preciseValue);
                // console.log(el.preciseValueRounding);
                // console.log(Number(el.preciseValue.toFixed(el.preciseValueRounding)));
                return Number(el.value);
            }
        }

        function updatePreciseOnInput(el) {
            el.preciseValue = Number(el.value);
        }

        // disables the target element (of the main three), and enables the other two.
        function setTargetElement(target) {
            ["og", "fg", "abv"].forEach(id => {
                getid(id).disabled = (id === target);
            });
        }

        // get the id of the currently disabled element (this is the target element)
        function getTargetElement() {
            return ["og", "fg", "abv"].find(id => getid(id).disabled);
        }

        // when the "target" (solve for) radio selection is changed.
        function targetChanged(el) {
            const newTarget = document.forms.calc.elements.target.value;
            setTargetElement(newTarget);
        }

        function tempCorrectionToggle(el) {
            if (el === undefined) el = getid("tempcorrection");
            if (el.checked) {
                $(".tempcorrectionon").removeClass("d-none");
                $(".tempcorrectionoff").addClass("d-none");
            } else {
                $(".tempcorrectionon").addClass("d-none");
                $(".tempcorrectionoff").removeClass("d-none");
            }
        }

        // update calculations when some input has changed.
        // this is called on update by some forms, in which case we will update
        // their preciseValue too.
        function updateCalculations(el) {
            if (el) {
                if (el.disabled) return;
                else updatePreciseOnInput(el);
            }

            
            var target = getTargetElement();
            switch (target) {
                case "abv": updateABV(); break;
                case "og": updateOG(); break;
                case "fg": updateFG(); break;
            }

            // always update the secondary fields
            updateTemps();
            updateSecondary();
        }

        function updateSecondary() {
            const fg = getMaybeTempCorrected("fg");
            const abv = getnum("abv");
            const nafg = updateNAFG(abv, fg);
            updateRS(nafg);
            updateDelle(abv);
        }

        function updateOG(fg, abv) {
            if (fg===undefined) fg = getMaybeTempCorrected("fg");
            if (abv===undefined) abv = getnum("abv");
            const og = OGFromFGABV(fg, abv);
            setMaybeTempCorrected("og", og, 3);
            // setnum("og", og, 3);
            return og;
        }

        function updateFG(og, abv) {
            if (og===undefined) og = getMaybeTempCorrected("og");
            if (abv===undefined) abv = getnum("abv");
            const fg = FGFromOGABV(og, abv);
            setMaybeTempCorrected("fg", fg, 3);
            // setnum("fg", fg, 3);
            return fg;
        }

        function updateABV(og, fg) {
            if (og===undefined) og = getMaybeTempCorrected("og");
            if (fg===undefined) fg = getMaybeTempCorrected("fg");
            const abv = ABVFromSGs(og, fg);
            setnum("abv", abv, 2);
            return abv;
        }

        function updateNAFG(abv, fg) {
            if (abv === undefined) abv = getnum("abv");
            if (fg === undefined)  fg = getMaybeTempCorrected("fg");
            const nafg = adjustForAlcohol(fg, abv);
            setnum("nafg", nafg, 4);
            return nafg;
        }

        function updateRS(nafg) {
            if (nafg === undefined) nafg = getnum("nafg");
            const rs = BrixFromSG(nafg) * nafg;
            setnum("rs", rs, 3);
            return rs;
        }

        function updateDelle(abv, rs) {
            if (abv === undefined) abv = getnum("abv");
            if (rs === undefined) rs = getnum("rs");
            const delle = DelleFromRSABV(rs, abv);
            setnum("delle", delle, 1);
            return delle;
        }


        // conversions
        function getABVMethod() {
            return (getid("abvmethod").value);
        }

        function ABVFromSGs(og, fg) {
            switch (getABVMethod()) {
                case "BAUME":
                    return BaumeABV(og, fg);
                case "LINEAR":
                    return LinearABV(og, fg);
                case "DUNCANACTON":
                    return DuncanActonABV(og, fg);
                default:
                    alert("something went wrong. I guess we haven't finished developing this ABV calculation method yet."); return;
            }
        }

        function OGFromFGABV(fg, abv) {
            switch (getABVMethod()) {
                case "BAUME":
                    return BaumeOG(fg, abv);
                case "LINEAR":
                    return LinearOG(fg, abv);
                case "DUNCANACTON":
                    return DuncanActonOG(fg, abv);
                default:
                    alert("something went wrong. I guess we haven't finished developing this ABV calculation method yet."); return;
            }
        }

        function FGFromOGABV(og, abv) {
            switch (getABVMethod()) {
                case "BAUME":
                    return BaumeFG(og, abv);
                case "LINEAR":
                    return LinearFG(og, abv);
                case "DUNCANACTON":
                    return DuncanActonFG(og, abv);
                default:
                    alert("something went wrong. I guess we haven't finished developing this ABV calculation method yet."); return;
            }
        }

        // the Baume method
        function BaumeABV(og, fg) {
            return 145-145/(1+og-fg);
        }

        function BaumeFG(og, abv) {
            return (1+og) - 145/(145-abv);
        }

        function BaumeOG(fg, abv) {
            return 145/(145-abv) - (1-fg);
        }

        // the linear method
        function LinearABV(og, fg) {
            return (og-fg)*131.25;
        }

        function LinearFG(og, abv) {
            return og - (abv/131.25);
        }

        function LinearOG(fg, abv) {
            return (abv/131.25) + fg;
        }

        // the Duncan Acton method
        function DuncanActonABV(og, fg, k) {
            if (k === undefined) k = 0.007;
            const abv = (1000 * (og - fg)) / (7.75 - (3.75 * (og - k - 1)));
            return abv;
        }

        function DuncanActonFG(og, abv, k) {
            if (k === undefined) k = 0.007;
            const fg = og + (abv*3.75*og - abv*(3.75*k + 11.5))/1000;
            return fg;
        }

        function DuncanActonOG(fg, abv, k) {
            if (k === undefined) k = 0.007;
            const og = (1000*fg + abv*(3.75*k + 11.5))/(1000 + abv*3.75);
            return og;
        }

        // "Smart" rounding. Do a small round if you ever find '000' or '999'
        // in the decimal places. This is a weird round with a base 10 bias, but
        // it makes numbers that look nice, and it often corrects for rounding
        // errors created by recalculating using complex calculated numbers, as
        // often happens when you change target.
        function smartRound(n) {
            // ignore if already simple under 4dp
            if (n == Number(n.toFixed(4))) return n;

            const decimals = n.toString().substring(n.toString().indexOf('.')+1);
            const zeroes = decimals.indexOf('000');
            const nines  = decimals.indexOf('999');

            var cutoff;
            if (zeroes === -1 && nines === -1) return n;
            if (zeroes > -1 && nines > -1) cutoff = Math.min(zeroes, nines);
            else cutoff = Math.max(zeroes, nines);

            const simpleN = Number(n.toFixed(cutoff));
            console.log("simplified", n, "to", simpleN);
            return simpleN;
        }

        function adjustForAlcohol(sg, abv) {
            /* const removeEthanol = (sg*100 - 0.789*abv) / (100-abv);
            const diluteBackToVolume = (removeEthanol*(100-abv) + abv) / 100;
            return diluteBackToVolume;
            this simplifies to the following */
            return sg + 0.00211 * abv;
        }


        function BrixFromSG(sg) {
            const brix = 182.4601 * Math.pow(sg, 3)
                       - 775.6821 * Math.pow(sg, 2)
                       + 1262.7794 * sg
                       - 669.5622;
            return brix;
        }

        function DelleFromRSABV(rs, abv) {
            if (rs === undefined) rs = getnum("rs");
            if (abv === undefined) abv = getnum("abv");
            return 4.5 * abv + rs;
        }

        function performingTempCorrection() {
            return getid("tempcorrection").checked;
        }

        function getMaybeTempCorrected(id) {
            if (!performingTempCorrection())
                return getnum(id);
            if (id === "og") return getTempCorrectedOG();
            if (id === "fg") return getTempCorrectedFG();
            return getnum(id);
        }

        // returning setnum(...), which is undefined, but thats ok.
        function setMaybeTempCorrected(id, val, dp=3) {
            if (!performingTempCorrection())
                return setnum(id, val, dp);
            if (id === "og") return setnum("og", getReverseTempCorrectedOG(val), dp);
            if (id === "fg") return setnum("fg", getReverseTempCorrectedFG(val), dp);
            return setnum(id, val, dp);
        }

        function getReverseTempCorrectedOG(og) {
            const readTemp = getnum("ogtemp");
            const basisTemp = getTemperatureBasis();

            if (getTemperatureUnit() === 'F')
                return adjustSGForTempF(og, readTemp, basisTemp);
            return adjustSGForTempC(og, readTemp, basisTemp);
        }

        function getReverseTempCorrectedFG(fg) {
            const readTemp = getnum("fgtemp");
            const basisTemp = getTemperatureBasis();

            if (getTemperatureUnit() === 'F')
                return adjustSGForTempF(fg, readTemp, basisTemp);
            return adjustSGForTempC(fg, readTemp, basisTemp);
        }

        // temperature adjustments
        function getTempCorrectedOG() {
            const readOG = getnum("og");
            if (!performingTempCorrection()) return readOG;
            const readTemp = getnum("ogtemp");
            const basisTemp = getTemperatureBasis();

            if (getTemperatureUnit() === 'F')
                return adjustSGForTempF(readOG, basisTemp, readTemp);
            return adjustSGForTempC(readOG, basisTemp, readTemp);
        }

        function getTempCorrectedFG() {
            const readOF = getnum("fg");
            if (!performingTempCorrection()) return readOF;
            const readTemp = getnum("fgtemp");
            const basisTemp = getTemperatureBasis();

            if (getTemperatureUnit() === 'F')
                return adjustSGForTempF(readOF, basisTemp, readTemp);
            return adjustSGForTempC(readOF, basisTemp, readTemp);
        }

        function updateTemps() {
            // update temperature symbol on form.
            $(".show-temp-unit").html(getTemperatureSymbol());
            $(".show-basis-temp").html(Number(getTemperatureBasis().toFixed(2)));
            $("#ogtempcorrected").html(getTempCorrectedOG().toFixed(3));
            $("#fgtempcorrected").html(getTempCorrectedFG().toFixed(3));
        }

        function getTemperatureBasis(unit) {
            if (unit===undefined) unit=getTemperatureUnit();
            const basis = getTemperatureBasisC();
            if (unit === 'C')
                return basis;
            return CtoF(basis);
        }

        function CtoF(c) {
            return c*1.8 + 32;
        }

        function FtoC(f) {
            return (f-32)/1.8;
        }

        function getTemperatureBasisC() {
            switch (getABVMethod()) {
                case "BAUME":
                    // fixme: Find out what the basis temp for Baume is
                    return 20;
                case "LINEAR":
                    return FtoC(60);
                case "DUNCANACTON":
                    return FtoC(60);
                default:
                    return 20;
            }
        }

        function getTemperatureUnit() {
            return document.forms.calc.elements.tempunit.value;
        }

        function getTemperatureSymbol(tempunit) {
            if (tempunit===undefined) tempunit = getTemperatureUnit();
            if (tempunit==="F")
                return "&#8457";
            return "&#8451";
        }

        // adjust specific gravity for temperature (Farenheit)
        // this is the same polynomial as used by VinoCalc https://www.vinolab.hr/calculator/hydrometer-temperature-correction-en31
        // and other places. I just rearranged it a little.
        function adjustSGForTempF(sg, ctF, rtF) {
            const coeff = ((100130.346 - (rtF * 13.4722124) + (rtF*rtF * 0.204052596) - (rtF*rtF*rtF * 0.000232820948))
                         / (100130.346 - (ctF * 13.4722124) + (ctF*ctF * 0.204052596) - (ctF*ctF*ctF * 0.000232820948)));
            return (sg * coeff);
        }

        // adjust specific gravity for temperature (Celcius)
        function adjustSGForTempC(sg, ctC, rtC) {
            const coeff = (99900.5559846799 - (rtC * 2.03052997486) + (rtC*rtC * 0.5887137834) - (rtC*rtC*rtC * 0.001357811768736))
                        / (99900.5559846799 - (ctC * 2.03052997486) + (ctC*ctC * 0.5887137834) - (ctC*ctC*ctC * 0.001357811768736));
            return (sg * coeff);
        }






        // INIT

        tempCorrectionToggle();
        updateCalculations();

        // interface stuff
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, {html:true, container: 'body'});
        });
      </script>
</body>
</html>