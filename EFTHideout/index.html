
<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" />
  <head>
    <title>Hideout D3 Cola</title>
    <link rel="stylesheet" type="text/css" href="font/MyFontsWebfontsKit.css">
    <link rel="stylesheet" type="text/css" href="hideoutstyle.css">
    <script src="d3.v4.min.js"></script>
    <script src="cola.min.js"></script>
  </head>
  <body>
  <script>
    // CONFIG
    var width  = window.document.documentElement.clientWidth-50,
        height = window.document.documentElement.clientHeight;

    var nodeRadius = 30;
    var nodeSpacing = 90;
    var hexScale = nodeRadius/10;
    var store = window.localStorage;

    var normalHex = "-8.6 -5,0 -10,8.6 -5,8.6 5,0 10,-8.6 5";
    var biggerHex = "-13 -7.5,0 -15,13 -7.5,13 7.5,0 15,-13 7.5";

    // SETUP LIBS
    var d3cola = cola.d3adaptor(d3)
        .avoidOverlaps(true)
        .size([width, height]);
    
    d3cola.on("tick", tick);

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);
    
    // GLOBAL
    var graph;
    var gnodes = svg.selectAll(".gnode");
    var paths = svg.selectAll(".path");
    var markers;

    // helper to process JSON links (so we don't have to write stuff by index)
    d3.json("hideout2.json", function (error, graph_) {
      graph = graph_;
      // process named links
      graph.dict = [];
      graph.nodes.forEach(function (n, i) {
        graph.dict[n.id] = i;
        n.height = n.width = nodeRadius*2.5;
        n.built = (store[`built_${n.id}`]==="true");
      });

      graph.links = [];
      graph.namedlinks.forEach(function(l){
        var newlink = {...l}; // clone the link
        newlink.source = graph.dict[l.source];
        newlink.target = graph.dict[l.target];
        graph.links.push(newlink);
      });

      //define a few markers
      svg.append('svg:defs').selectAll('marker')
         .data(['normal', 'red', 'green']).enter()
         .append('svg:marker')
          .attr('id', (t)=>`end-arrow-${t}`)
          .attr('viewBox', '0 -5 10 10')
          .attr('refX', 6)
          .attr('markerWidth', 3)
          .attr('markerHeight', 3)
          .attr('orient', 'auto')
          .append('svg:path')
            .attr('d', 'M0,-5L10,0L0,5');

      buildGraph();


      d3.select("body")
            .on("click", outsideClick)
            .on("keydown", keyDown);
    });



    function deleteSome() {
      // graph.nodes = graph.nodes.filter(function(n, i){
      //   if (i%2===0) {
      //     // n.hidden = true;
      //     // return false;
      //   }
      //   return true;
      // });

      // graph.links = graph.links.filter(function(l,i) {
      //   console.log(l);
      //   // return false;
      // });
      graph.nodes.splice(1,1);

      buildGraph();
      d3cola.start(1,1,1);
    }

    var getIcon = function(n) {
      return `icons/${n.type}.png`;
    };

    var prettyNodeName = function(n) {
      return `${n.type} Level ${n.level}`;
    }

    function buildGraph() {

      d3cola
          .nodes(graph.nodes)
          .links(graph.links)
          // .flowLayout("y", nodeRadius*2.5)
          // .symmetricDiffLinkLengths(18)
          // .linkDistance(nodeSpacing)
          ;

      // build (add and remove) paths
      paths.data(graph.links)
        .enter().append('svg:path')
          .attr('class', 'path')
        .exit().remove();
      paths = svg.selectAll(".path")


      gnodes = gnodes.data(graph.nodes)
        .enter().append("g")
          .attr("id", (n)=>n.id)
          .attr("class", "gnode")
          .classed("built", (n)=>n.built);

      gnodes.append("polygon")
            .attr("class", "hex")
            .attr("points", normalHex)
            .attr("transform", `scale(${hexScale})`)

      gnodes.append("image")
            .attr("class", "image")
            .attr("xlink:href", getIcon)
            .attr("transform", `scale(${hexScale/4})`)
            .attr("x", -25)
            .attr("y", -25)
            .attr("height", 50)
            .attr("width", 50);
      
      gnodes.append("text")
            .attr("class", "level")
            .text((n) => "0"+n.level)
            .attr("x", nodeRadius/2)
            .attr("y", nodeRadius/2)
            .attr("transform", `scale(${hexScale/3})`);
      
      gnodes.append("polygon")
          .attr("class", "nodeCover")
          .attr("points", normalHex)
          .attr("transform", `scale(${hexScale})`)
          .on("mouseover", mouseover)
          .on("mouseout", mouseout)
          .on("click", nodeClick)
          .on("dblclick", nodeDblClick)
          .call(d3cola.drag)
          .append("title")
            .text(prettyNodeName);

      gnodes.exit().remove();
      gnodes = svg.selectAll(".gnode");

      d3cola.start(10,20,20);
    };

    function tick() {
      // draw directed edges with proper padding from node centers
      paths.attr('d', function (d) {
            var deltaX = d.target.x - d.source.x,
                deltaY = d.target.y - d.source.y,
                dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
                normX = deltaX / dist,
                normY = deltaY / dist,
                sourcePadding = nodeRadius,
                targetPadding = nodeRadius + 2,
                sourceX = d.source.x + (sourcePadding * normX),
                sourceY = d.source.y + (sourcePadding * normY),
                targetX = d.target.x - (targetPadding * normX),
                targetY = d.target.y - (targetPadding * normY);
            return 'M' + sourceX + ',' + sourceY + 'L' + targetX + ',' + targetY;
        });

        
        gnodes.attr("transform", function (d) {
            return `translate(${d.x}, ${d.y})`;
        });

    }

    function updateNodeDisplays() {
      if (sel = getSelectedNode) {
        paths.classed("red",   (l) => l.target.selected && !l.source.built);
        paths.classed("green", (l) => l.target.selected &&  l.source.built);
      }
    }

    function updateBuiltStatus() {
      gnodes.classed("built", (n) => n.built);
    }

    function nodeDblClick(n) {
    //   n.built = !n.built;
    

    //   var hex = d3.select(`polygon#hex${n.id}`);
    //   hex.classed("built", n.built);
    }

    function setSelected(b) {
      return function(n) {
        n.selected = b; return b;
      }
    }

    function deleteNode(n) {
      console.log(n);
      deleteSome();
    }






    function getSelectedNode() {
      for (var i=0; i<graph.nodes.length; i++) {
        if (graph.nodes[i].selected) return graph.nodes[i];
      }
    }


    function toggleBuilt(n) {
      n.built = !n.built;
      store[`built_${n.id}`] = n.built;
    }

    function keyDown(e) {
      if (event.code==="KeyB") {
        if (n = getSelectedNode()) {
          toggleBuilt(n);
          updateBuiltStatus();
        }
      } else if (event.code==="KeyR") {
        if (n = getSelectedNode()) {
          console.log('deleting '+n.id);
          deleteNode(n);
        }
      }
    }
    
    function nodeClick(n) {
      console.log(n);
      // this click shouldn't also register on the background
      d3.event.stopPropagation();
      console.log(this.parentNode);

      var thisGNode = d3.select(this.parentNode);
      if (thisGNode.classed("selected")) {
        // already selected. unselect
        thisGNode.classed("selected", setSelected(false));
      } else {
        // not selected. unselect everything else and select this.
        gnodes.classed("selected", setSelected(false));
        thisGNode.classed("selected", setSelected(true));
      }
      updateNodeDisplays();
    }

    function outsideClick() {
      gnodes.classed("selected", setSelected(false));
      updateNodeDisplays();
    }

    function mouseover(n) {
      console.log(n);
      d3.event.stopPropagation();
      d3.select(`polygon#${n.id}`)
        .transition()
        .duration(250)
        .style("opacity", 0.3)
        .attr("points", biggerHex);
    }

    function mouseout(n) {
      d3.event.stopPropagation();
      d3.select(`polygon#${n.id}`)
        .transition()
        .duration(250)
        .style("opacity", 0.6)
        .attr("points", normalHex);
    }

</script>
</body>
</html>
